# Faiz Essa
# Difference-in-differences plots for paper
# April 24th, 2023

#### SETUP ####
rm(list=ls())

# importing packages 
library(tidyverse)
library(did)

#### AGREGGATING GDELT TREATMENT EFFECTS ####
depvars <- c("protest_count", "fight_count", "assault_count",
             "log_protests", "log_assaults", "log_fights")

for (y in depvars) {
  # filepath
  filepath <- paste("/Users/faizessa/Documents/Data/GDELTProtestDiD/", 
                    y, ".rds", sep = "")
  # import estimates
  estimates <- readRDS(filepath)
  
  # aggregating treatment effects into event study plot
  agg <- aggte(MP = estimates, type = "dynamic", min_e = -8, max_e = 8)
  
  # saving estimates and SE's to dataframe
  df <- data.frame(agg[["att.egt"]], agg[["se.egt"]])
  colnames(df) <- c("coef", "se")
  df <- df %>%
    mutate(ci = se * 1.96) %>%
    mutate(depvar = y) %>% 
    relocate(depvar, .before = "coef")
  time <- -8:8
  df <- cbind(time, df)
  # adding depvar to column names
  assign(y, df)
  rm(filepath, estimates, agg, df)
}


#### GENERATING GDELT PLOTS ####
log_estimates <- rbind(log_protests, log_assaults, log_fights)
count_estimates <- rbind(protest_count, assault_count, fight_count)

pd <- position_dodge(.5) # move points to the left and right

# raw counts plot
ggplot(count_estimates, aes(x=time, y=coef, colour=depvar, shape=depvar)) + 
  geom_errorbar(aes(ymin=coef-ci, ymax=coef+ci), width=.1, position=pd) +
  geom_point(position=pd) +
  scale_colour_manual(values = c("black", "salmon", "green"), 
                      labels=c('Assaults', 'Fights', 
                               'Protests')) +
  scale_shape_manual(values=c(20, 17, 15),
                     labels=c('Assaults', 'Fights', 
                             'Protests')) +
  labs(y = 'Average effect by length of exposure', 
       colour = "Dependent variable", shape = "Dependent variable",
       x = "Weeks to first shutdown") +
  geom_hline(yintercept = 0, color = "darkred") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred") +
  theme_light() +
  theme(text = element_text(size = 14)) 


ggsave("results/Draft2DiDv2/gdelt_counts_did.pdf")

# log plot
ggplot(log_estimates, aes(x=time, y=coef, colour=depvar, shape=depvar)) + 
  geom_errorbar(aes(ymin=coef-ci, ymax=coef+ci), width=.1, position=pd) +
  geom_point(position=pd) +
  scale_colour_manual(values = c("black", "salmon", "green"), 
                      labels=c('ln(Assaults+1)', 'ln(Fights+1)', 
                               'ln(Protests+1')) +
  scale_shape_manual(values=c(20, 17, 15),
                     labels=c('ln(Assaults+1)', 'ln(Fights+1)', 
                              'ln(Protests+1')) +
  labs(y = 'Average effect by length of exposure', 
       colour = "Dependent variable", shape = "Dependent variable",
       x = "Weeks to first shutdown") +
  geom_hline(yintercept = 0, color = "darkred") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred") +
  theme_light() +
  theme(text = element_text(size = 14)) 

ggsave("results/Draft2DiDv2/gdelt_logs_did.pdf")

#### AGREGGATING PROWESS TREATMENT EFFECTS ####

rm(list=ls())

depvars <- c("AvgBSEPrice", "log_BSE",
             "AvgNSEPrice", "log_NSE")

for (y in depvars) {
  # filepath
  filepath <- paste("/Users/faizessa/Documents/Data/ProwessDiD/", 
                    y, ".rds", sep = "")
  # import estimates
  estimates <- readRDS(filepath)
  
  # aggregating treatment effects into event study plot
  agg <- aggte(MP = estimates, type = "dynamic", min_e = -8, max_e = 8, na.rm = TRUE)
  
  # saving estimates and SE's to dataframe
  df <- data.frame(agg[["att.egt"]], agg[["se.egt"]])
  colnames(df) <- c("coef", "se")
  df <- df %>%
    mutate(ci = se * 1.96) %>%
    mutate(depvar = y) %>% 
    relocate(depvar, .before = "coef")
  time <- -8:8
  df <- cbind(time, df)
  # adding depvar to column names
  assign(y, df)
  rm(filepath, estimates, agg, df)
}

### MAKING PROWESS PLOTS ####
log_estimates <- rbind(log_BSE, log_NSE)
estimates <- rbind(AvgBSEPrice, AvgNSEPrice)

pd <- position_dodge(.5) # move points to the left and right

# raw price plot
ggplot(estimates, aes(x=time, y=coef, colour=depvar, shape = depvar)) + 
  geom_errorbar(aes(ymin=coef-ci, ymax=coef+ci), width=.1, position=pd) +
  geom_point(position=pd) +
  geom_line(position=pd) +
  scale_colour_manual(values = c("black", "salmon"), 
                      labels=c('BSE Price', 'NSE Price')) +
  scale_shape_manual(values = c(20, 17), 
                      labels=c('BSE Price', 'NSE Price')) +
  labs(y = 'Average effect by length of exposure', 
       colour = "Dependent variable", shape = "Dependent variable",
       x = "Weeks to first shutdown") +
  geom_hline(yintercept = 0, color = "darkred") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred") +
  theme_light() +
  theme(text = element_text(size = 14)) 


ggsave("results/Draft2DiDv2/prowess_price_did.pdf")

# log price plot
ggplot(log_estimates, aes(x=time, y=coef, colour=depvar, shape = depvar)) + 
  geom_errorbar(aes(ymin=coef-ci, ymax=coef+ci), width=.1, position=pd) +
  geom_point(position=pd) +
  geom_line(position=pd) +
  scale_colour_manual(values = c("black", "salmon"), 
                      labels=c('ln(BSE Price)', 'ln(NSE Price)')) +
  scale_shape_manual(values = c(20, 17), 
                     labels=c('BSE Price', 'NSE Price')) +
  labs(y = 'Average effect by length of exposure', 
       colour = "Dependent variable", shape = "Dependent variable",
       x = "Weeks to first shutdown") +
  geom_hline(yintercept = 0, color = "darkred") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred") +
  theme_light() + 
  theme(text = element_text(size = 14))

ggsave("results/Draft2DiDv2/prowess_log_did.pdf")

#### AGREGGATING GDELT TONE TREATMENT EFFECTS ####

estimates <- readRDS("/Users/faizessa/Documents/Data/GDELTToneDiD/zscore.rds")

agg <- aggte(MP = estimates, type = "dynamic", min_e = -8, max_e = 8, na.rm = TRUE)

zscore <- data.frame(agg[["att.egt"]], agg[["se.egt"]])
colnames(zscore) <- c("coef", "se")
zscore <- zscore %>%
  mutate(ci = se * 1.96) 
time <- -8:8
zscore <- cbind(time, zscore)

ggplot(zscore, aes(x=time, y=coef)) + 
  geom_errorbar(aes(ymin=coef-ci, ymax=coef+ci), width=.1) +
  geom_point() +
  geom_line() +
  labs(y = 'Average effect by length of exposure', 
       x = "Weeks to first shutdown") +
  geom_hline(yintercept = 0, color = "darkred") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred") +
  theme_light() + 
  theme(text = element_text(size = 14))

ggsave("results/Draft2DiDv2/gdelt_tone.pdf")
